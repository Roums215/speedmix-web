// ---------- Configuration globale et variables partagÃ©es ---------- //
console.log("Initialisation de global.js");

// Objet global pour toute l'application
window.APP = {
    // Configuration de l'application
    CONFIG: {
        gps: { updateInterval: 1000, simulationMode: true },
        acceleration: { threshold: 10, duration: 2 },
        stabilization: { threshold: 5, duration: 5 }
    },
    
    // Ã‰tat de l'application
    STATE: {
        currentSpeed: 0,
        currentAcceleration: 0,
        previousSpeed: 0,
        speedHistory: [],
        isStabilized: false,
        isPlaying: false,
        tracks: [],
        usingRealGPS: false,
        autoSimulation: false
    },
    
    // Fonctions GPS et accÃ©lÃ©romÃ¨tre
    GPS: {
        // Variables de suivi
        simulationInterval: null,
        gpsWatchId: null,
        autoSimulationInterval: null,
        
        // Fonctions principales
        initSimulation: function() {
            console.log("GPS.initSimulation appelÃ©");
            if (window.DOM && window.DOM.simSpeedSlider && window.DOM.simSpeedValue) {
                window.DOM.simSpeedValue.textContent = `${window.DOM.simSpeedSlider.value} km/h`;
                window.DOM.simAccelValue.textContent = `${window.DOM.simAccelSlider.value} km/h/s`;
            }
        },
        
        startSimulation: function() {
            console.log("GPS.startSimulation appelÃ©");
            if (APP.GPS.simulationInterval) clearInterval(APP.GPS.simulationInterval);
            
            APP.STATE.usingRealGPS = false;
            APP.STATE.autoSimulation = false;
            
            APP.UTILS.updateStatusMessage("Mode simulation manuelle activÃ©");
            
            if (window.DOM && window.DOM.simSpeedSlider) {
                APP.GPS.updateSpeed(parseFloat(window.DOM.simSpeedSlider.value));
                
                APP.GPS.simulationInterval = setInterval(() => {
                    if (window.DOM && window.DOM.simAccelSlider) {
                        APP.GPS.updateAcceleration(parseFloat(window.DOM.simAccelSlider.value));
                    }
                }, 100);
            }
        },
        
        stopSimulation: function() {
            console.log("GPS.stopSimulation appelÃ©");
            if (APP.GPS.simulationInterval) {
                clearInterval(APP.GPS.simulationInterval);
                APP.GPS.simulationInterval = null;
            }
        },
        
        toggleGPSMode: function() {
            console.log("GPS.toggleGPSMode appelÃ©");
            if (window.DOM && window.DOM.btnSimGps) {
                if (APP.STATE.usingRealGPS) {
                    // Si on utilise le GPS rÃ©el, passer Ã  la simulation
                    APP.GPS.stopGPSTracking();
                    APP.GPS.stopMotionTracking();
                    APP.GPS.stopAutoSimulation();
                    APP.GPS.startSimulation();
                    window.DOM.btnSimGps.textContent = "Auto-Simulation";
                    APP.UTILS.updateStatusMessage("Mode simulation manuelle activÃ©");
                } else if (APP.GPS.autoSimulationInterval === null) {
                    // Si on est en simulation manuelle, passer Ã  l'auto-simulation
                    APP.GPS.stopSimulation();
                    APP.GPS.startAutoSimulation();
                    window.DOM.btnSimGps.textContent = "Utiliser GPS rÃ©el";
                } else {
                    // Si on est en auto-simulation, passer au GPS rÃ©el
                    APP.GPS.stopSimulation();
                    APP.GPS.stopAutoSimulation();
                    APP.GPS.startMotionAndGPSTracking();
                    window.DOM.btnSimGps.textContent = "Utiliser simulation";
                }
            } else {
                console.error("DOM non disponible pour toggleGPSMode");
            }
        },
        
        updateSimulatedSpeed: function() {
            console.log("GPS.updateSimulatedSpeed appelÃ©");
            if (window.DOM && window.DOM.simSpeedSlider && window.DOM.simSpeedValue) {
                const speed = parseFloat(window.DOM.simSpeedSlider.value);
                window.DOM.simSpeedValue.textContent = `${speed} km/h`;
                APP.GPS.updateSpeed(speed);
            }
        },
        
        updateSimulatedAcceleration: function() {
            console.log("GPS.updateSimulatedAcceleration appelÃ©");
            if (window.DOM && window.DOM.simAccelSlider && window.DOM.simAccelValue) {
                const accel = parseFloat(window.DOM.simAccelSlider.value);
                window.DOM.simAccelValue.textContent = `${accel} km/h/s`;
                APP.GPS.updateAcceleration(accel);
            }
        },
        
        startMotionAndGPSTracking: function() {
            console.log("DÃ©marrage du suivi GPS et des capteurs de mouvement");
            APP.STATE.usingRealGPS = true;
            APP.GPS.startEnhancedGPSTracking();
            APP.GPS.startMotionTracking();
        },
        
        updateSpeed: function(speed) {
            APP.STATE.currentSpeed = speed;
            APP.UTILS.updateSpeedDisplay();
            APP.AUDIO.adaptMusicToSpeed();
        },
        
        updateAcceleration: function(acceleration) {
            APP.STATE.currentAcceleration = acceleration;
            APP.UTILS.updateSpeedDisplay();
        },
        
        // Fonctions stub Ã  implÃ©menter plus tard
        startEnhancedGPSTracking: function() { console.log("GPS rÃ©el activÃ©"); },
        stopGPSTracking: function() { console.log("GPS rÃ©el dÃ©sactivÃ©"); },
        startMotionTracking: function() { console.log("Capteurs de mouvement activÃ©s"); },
        stopMotionTracking: function() { console.log("Capteurs de mouvement dÃ©sactivÃ©s"); },
        startAutoSimulation: function() { console.log("Auto-simulation activÃ©e"); },
        stopAutoSimulation: function() { console.log("Auto-simulation dÃ©sactivÃ©e"); }
    },
    
    // Fonctions utilitaires
    UTILS: {
        updateStatusMessage: function(message) {
            console.log("Message d'Ã©tat: " + message);
            if (window.DOM && window.DOM.status) {
                window.DOM.status.textContent = message;
            }
        },
        
        updateSpeedDisplay: function() {
            if (!window.DOM) return;
            
            // Vitesse
            if (DOM.speed) {
                DOM.speed.textContent = `${APP.STATE.currentSpeed.toFixed(1)} `;
            }
            
            // AccÃ©lÃ©ration
            if (DOM.acceleration) {
                DOM.acceleration.textContent = `${APP.STATE.currentAcceleration.toFixed(1)} km/h/s`;
            }
            
            // Ã‰tat et style selon la vitesse
            if (DOM.speed && DOM.speedStatus && DOM.status) {
                DOM.status.textContent = APP.STATE.isStabilized ? "Stable" : "Variable";
                
                // Reset de la classe
                DOM.speed.className = 'speed-value';
                
                if (APP.STATE.currentAcceleration > APP.CONFIG.acceleration.threshold) {
                    DOM.speedStatus.textContent = 'ðŸš€ AccÃ©lÃ©ration!';
                    DOM.speed.classList.add('accelerating');
                } else if (APP.STATE.isStabilized) {
                    DOM.speedStatus.textContent = 'ðŸŽµ Vitesse stabilisÃ©e';
                    DOM.speed.classList.add('stabilized');
                } else {
                    DOM.speedStatus.textContent = 'ðŸš— En mouvement';
                }
            }
        },
        
        formatTime: function(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    },
    
    // Fonctions audio
    AUDIO: {
        adaptMusicToSpeed: function(speed) {
            try {
                // Si pas de paramÃ¨tre, utiliser la vitesse stockÃ©e
                if (speed === undefined) {
                    speed = APP.STATE.currentSpeed;
                }
                
                console.log("Adaptation musicale selon vitesse:", speed);
                
                // VÃ©rifier que le lecteur audio est disponible
                if (!window.audioContext || !window.currentSource) {
                    console.warn("Lecteur audio non disponible pour l'adaptation Ã  la vitesse");
                    return;
                }
                
                // ParamÃ¨tres d'adaptation
                let playbackRate = 1.0;
                let filterFrequency = 22050; // valeur par dÃ©faut (pas de filtrage)
                let reverbAmount = 0;
                
                // Modifier le tempo en fonction de la vitesse
                if (speed < 5) {
                    // Vitesse faible - tempo lent
                    playbackRate = 0.85 + (speed / 20); // de 0.85 Ã  1.0
                    filterFrequency = 1000 + (speed * 200); // de 1000Hz Ã  2000Hz
                    reverbAmount = 0.3 - (speed / 50); // plus de reverb Ã  basse vitesse
                } else if (speed < 30) {
                    // Vitesse moyenne - tempo normal
                    playbackRate = 1.0 + ((speed - 5) / 100); // de 1.0 Ã  1.25
                    filterFrequency = 2000 + ((speed - 5) * 400); // de 2000Hz Ã  12000Hz
                } else {
                    // Vitesse Ã©levÃ©e - tempo rapide
                    playbackRate = 1.25 + ((speed - 30) / 200); // de 1.25 Ã  1.5 max
                    filterFrequency = 12000 + ((speed - 30) * 300); // ouvrir davantage le filtre
                }
                
                // Limiter les valeurs
                playbackRate = Math.max(0.7, Math.min(playbackRate, 1.5));
                filterFrequency = Math.min(filterFrequency, 22050);
                
                // Appliquer les effets si disponibles
                if (window.currentSource) {
                    window.currentSource.playbackRate.value = playbackRate;
                    console.log("Playback rate ajustÃ© Ã : " + playbackRate.toFixed(2));
                }
                
                // Appliquer le filtre passe-bas si disponible
                if (window.lowpassFilter) {
                    window.lowpassFilter.frequency.value = filterFrequency;
                    console.log("Filtre passe-bas ajustÃ© Ã : " + filterFrequency.toFixed(0) + "Hz");
                }
                
                // Activer/dÃ©sactiver la rÃ©verbÃ©ration
                if (window.convolver && window.dryGain && window.wetGain) {
                    window.dryGain.gain.value = 1 - reverbAmount;
                    window.wetGain.gain.value = reverbAmount;
                    console.log("RÃ©verbÃ©ration ajustÃ©e Ã : " + (reverbAmount * 100).toFixed(0) + "%");
                }
            } catch (error) {
                console.error("Erreur lors de l'adaptation de la musique Ã  la vitesse:", error);
            }
        },
        
        adaptAudioToAcceleration: function(acceleration) {
            try {
                // Si pas de paramÃ¨tre, utiliser l'accÃ©lÃ©ration stockÃ©e
                if (acceleration === undefined) {
                    acceleration = APP.STATE.currentAcceleration;
                }
                
                console.log("Adaptation audio Ã  l'accÃ©lÃ©ration:", acceleration);
                
                // VÃ©rifier que le lecteur audio est disponible
                if (!window.audioContext || !window.currentSource) {
                    console.warn("Lecteur audio non disponible pour l'adaptation Ã  l'accÃ©lÃ©ration");
                    return;
                }
                
                // DÃ©tecter les fortes accÃ©lÃ©rations (positives ou nÃ©gatives)
                const accelMagnitude = Math.abs(acceleration);
                
                // Adapter les effets en fonction de l'accÃ©lÃ©ration
                if (accelMagnitude > 10) { // Forte accÃ©lÃ©ration
                    // Activer un filtre dynamique ou effet spÃ©cial
                    if (window.dynamicCompressor) {
                        const threshold = -24 - (accelMagnitude - 10); // De -24dB Ã  -34dB
                        window.dynamicCompressor.threshold.value = Math.max(-50, threshold);
                        
                        // Augmenter le ratio pour les accÃ©lÃ©rations trÃ¨s fortes
                        const ratio = 4 + (accelMagnitude / 5);
                        window.dynamicCompressor.ratio.value = Math.min(20, ratio);
                        
                        console.log(`Compresseur ajustÃ©: threshold=${window.dynamicCompressor.threshold.value}dB, ratio=${window.dynamicCompressor.ratio.value}:1`);
                    }
                    
                    // Ajouter un effet de distorsion lÃ©ger si disponible
                    if (window.distortion && typeof window.updateDistortion === 'function') {
                        const distortionAmount = Math.min(50, accelMagnitude) / 100;
                        window.updateDistortion(distortionAmount);
                        console.log("Distorsion ajustÃ©e Ã : " + (distortionAmount * 100).toFixed(0) + "%");
                    }
                    
                } else { // AccÃ©lÃ©ration normale ou faible
                    // RÃ©tablir les valeurs par dÃ©faut
                    if (window.dynamicCompressor) {
                        window.dynamicCompressor.threshold.value = -24;
                        window.dynamicCompressor.ratio.value = 4;
                    }
                    
                    if (window.distortion && typeof window.updateDistortion === 'function') {
                        window.updateDistortion(0); // DÃ©sactiver la distorsion
                    }
                }
            } catch (error) {
                console.error("Erreur lors de l'adaptation audio Ã  l'accÃ©lÃ©ration:", error);
            }
        }
    }
};

// Export global pour compatibilitÃ© avec le code existant
window.updateStatusMessage = APP.UTILS.updateStatusMessage;
window.formatTime = APP.UTILS.formatTime;
window.initSimulation = APP.GPS.initSimulation;
window.startSimulation = APP.GPS.startSimulation;
window.stopSimulation = APP.GPS.stopSimulation;
window.toggleGPSMode = APP.GPS.toggleGPSMode;
window.updateSimulatedSpeed = APP.GPS.updateSimulatedSpeed;
window.updateSimulatedAcceleration = APP.GPS.updateSimulatedAcceleration;
window.adaptMusicToSpeed = APP.AUDIO.adaptMusicToSpeed;

console.log("global.js chargÃ© avec succÃ¨s");
